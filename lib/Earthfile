VERSION --shell-out-anywhere --use-chmod --use-host-command --earthly-version-arg --use-copy-link 0.6

IMPORT github.com/defn/cloud/lib:master AS lib

FROM registry.fly.io/defn:dev-tower

ARG stack
ARG target

platform:
    RUN echo '{ "language": "python", "app": "poetry run python -m main" }' > cdktf.json
    COPY pyproject.toml poetry.lock .
    RUN ~/bin/e poetry install

update:
    FROM ${target}
    RUN ~/bin/e poetry update
    SAVE ARTIFACT poetry.lock

synth:
    FROM ${target}
    RUN ~/bin/e poetry run python -m main
    SAVE ARTIFACT cdktf.out

init:
    FROM +synth --target=${target}
    RUN --mount=type=cache,target=/home/ubuntu/.terraform.d/plugin-cache \
        cd cdktf.out/stacks/${stack} && ~/bin/e terraform init \
        && for f in \$(find -type l); do cp --remove-destination \$(readlink \$f) \$f;done;
    SAVE ARTIFACT cdktf.out/stacks/${stack}

plan:
    FROM +init --target=${target} --stack=${stack}
    RUN --no-cache --secret DIGITALOCEAN_TOKEN cd cdktf.out/stacks/${stack} && ~/bin/e terraform plan -out=.plan
    SAVE ARTIFACT cdktf.out AS LOCAL cdktf.out

apply:
    FROM +plan --target=${target} --stack=${stack}
    RUN --no-cache --secret DIGITALOCEAN_TOKEN cd cdktf.out/stacks/${stack} && ~/bin/e terraform apply .plan
    SAVE ARTIFACT cdktf.out AS LOCAL cdktf.out
